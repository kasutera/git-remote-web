#!/bin/bash

# git-remote-web - An external command for Git hosting service
# Supports GitHub

set -e

usage_exit() {
    cat <<_EOS_ 1>&2

  Usage: $PROGNAME [OPTIONS...] path

  OPTIONS:
    -h, --help
    --remote=REMOTE             specify remote name (default: origin)
    -b, --branch                branch URL
    -c, --commit                commit URL of current HEAD
    -p, --pull-request          pull request URL into master
    -o, --open                  open URL with browser
_EOS_
    exit 0
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Configuration
REMOTE_NAME="${REMOTE_NAME:-origin}"
SHOW_BRANCH=false
SHOW_COMMIT=false
SHOW_PR=false
OPEN_BROWSER=false
FILE_PATH=""

# Function to print error and exit
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Function to print success message
success() {
    echo -e "${GREEN}$1${NC}"
}

# Function to get remote URL
get_remote_url() {
    local remote=$1
    git config --get "remote.${remote}.url" || error "Remote '${remote}' not found"
}

# Function to normalize Git URL to HTTPS
normalize_url() {
    local url=$1
    # Convert SSH to HTTPS if needed
    if [[ $url =~ ^git@github.com:(.+)\.git$ ]]; then
        echo "https://github.com/${BASH_REMATCH[1]}"
    elif [[ $url =~ ^https://github.com/ ]]; then
        echo "${url%.git}"
    else
        error "Unsupported remote URL: $url"
    fi
}

# Function to get current branch
get_current_branch() {
    git rev-parse --abbrev-ref HEAD || error "Failed to get current branch"
}

# Function to get current commit hash
get_current_commit() {
    git rev-parse HEAD || error "Failed to get current commit"
}

# Function to get repository root
get_repo_root() {
    git rev-parse --show-toplevel || error "Failed to get repository root"
}

# Function to build branch URL
build_branch_url() {
    local base_url=$1
    local branch=$2
    
    if [[ $base_url =~ github.com ]]; then
        echo "${base_url}/tree/${branch}"
    fi
}

# Function to build commit URL
build_commit_url() {
    local base_url=$1
    local commit=$2
    local file_path=$3
    
    if [[ $base_url =~ github.com ]]; then
        if [ -n "$file_path" ]; then
            echo "${base_url}/blob/${commit}/${file_path}"
        else
            echo "${base_url}/commit/${commit}"
        fi
    fi
}

# Function to build file URL
build_file_url() {
    local base_url=$1
    local branch=$2
    local file_path=$3
    
    if [[ $base_url =~ github.com ]]; then
        echo "${base_url}/blob/${branch}/${file_path}"
    fi
}

# Function to build PR URL
build_pr_url() {
    local base_url=$1
    local branch=$2
    
    if [[ $base_url =~ github.com ]]; then
        echo "${base_url}/pull/new/${branch}"
    fi
}

# Parse arguments
while getopts "hbcpo-:" opt; do
    case $opt in
        h)
            usage_exit
            ;;
        b)
            SHOW_BRANCH=true
            ;;
        c)
            SHOW_COMMIT=true
            ;;
        p)
            SHOW_PR=true
            ;;
        o)
            OPEN_BROWSER=true
            ;;
        -)
            case "${OPTARG}" in
                branch)
                    SHOW_BRANCH=true
                    ;;
                commit)
                    SHOW_COMMIT=true
                    ;;
                pull)
                    SHOW_PR=true
                    ;;
                open)
                    OPEN_BROWSER=true
                    ;;
                remote=*)
                    REMOTE_NAME="${OPTARG#*=}"
                    ;;
                *)
                    error "Unknown option: --${OPTARG}"
                    ;;
            esac
            ;;
        \?)
            error "Unknown option: -${OPTARG}"
            ;;
    esac
done

# Shift off the options processed by getopts
shift $((OPTIND - 1))

# Remaining arguments are file paths
if [[ $# -gt 0 ]]; then
    FILE_PATH="$1"
fi

# Get remote URL and normalize it
REMOTE_URL=$(get_remote_url "$REMOTE_NAME")
BASE_URL=$(normalize_url "$REMOTE_URL")
BRANCH=$(get_current_branch)

# Determine what to show
if $SHOW_PR; then
    URL=$(build_pr_url "$BASE_URL" "$BRANCH")
elif $SHOW_COMMIT; then
    COMMIT=$(get_current_commit)
    URL=$(build_commit_url "$BASE_URL" "$COMMIT" "$FILE_PATH")
elif [ -n "$FILE_PATH" ]; then
    URL=$(build_file_url "$BASE_URL" "$BRANCH" "$FILE_PATH")
elif $SHOW_BRANCH; then
    URL=$(build_branch_url "$BASE_URL" "$BRANCH")
else
    URL="$BASE_URL"
fi

# Output URL
echo "$URL"

# Open in browser if requested (macOS only)
if $OPEN_BROWSER; then
    if command -v open &> /dev/null; then
        open "$URL"
    else
        error "The -o option is only supported on macOS"
    fi
fi
